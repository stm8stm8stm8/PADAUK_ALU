/***************************************PFC886+MF520PWM**********************************************/
/***************************************QQ:774145445*************************************************/
/****************************************快手:共同学习STM8*******************************************/
/****************************************20210423****************************************************/
//                     _________   _________
//              PWM2L-|1 pa2    \_/   pa1 20|-PWM2H
//              PWM1L-|2 pa3          pa0 19|-PWM1H
//              pwm0L-|3 pa4          pa7 18|-pwm0H
//                k_5-|4 pa5  pfc886  pa6 17|-led_1
//         与gnd相连|-|5 nc   mf520    nc 16|-|与vdd相连
//                  |-|6 gnd          vdd 15|-|
//                k_1-|7 pb0          pb7 14|-led_2
//                k_2-|8 pb1          pb6 13|-led_3
//                k_3-|9 pb2          pb5 12|-led_4
//                k_4-|10_pb3_________pb4_11|-led_5
/****************************************************************************************************/
//                          显示屏2353/188
//                            _2a_      _3a_
//                    正转| 2e   2b    |    |
//                        |  |    |    |    |
//                            -2f-      ----
//                    反转| 2e   2c    |    |
//                        |  |_2d_|    |____|
//                          @1 @2 @3 @4 @5
//                     ____________________________
//                    |   |led1|led2|led3|led4|led5|
//                    |_1_|_高_|_3A_|_3C_|_3E_|____|
//                    |_2_|_3B_|_高_|_2A_|_1B_|____|
//                    |_3_|_3D_|_2B_|_高_|_1A_|____|
//                    |_4_|_3F_|_2D_|_2C_|_高_|____|
//                    |_5_|_3G_|_2E_|_2F_|_2G_|_高_|
//共阳:0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90//0x88,0x83,0xc6,0xa1,0x86,0x8e
//共阴:0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,0x7f,0x6f//0x77,0x7c,0x39,0x5e,0x79,0x71
/****************************************************************************************************/
#include	"extern.h"
/****************************************************************************************************/
k_1			bit		pb.0;
k_2			bit		pb.1;
k_3			bit		pb.2;
k_4			bit		pb.3;
k_5			bit		pa.5;
led_1		bit		pa.6;
led_2		bit		pb.7;
led_3		bit		pb.6;
led_4		bit		pb.5;
led_5		bit		pb.4;
/****************************************************************************************************/
void		zhengxianbo();		//正弦波
void		fuzhi();			//赋值
void		yanshi();			//延时
void		yanshi1();			//延时1
void		dingge();			//定格
void		xianshi();			//显示
void		anjian();			//按键
/****************************************************************************************************/
word		a_1,b_1,c_1;		//abc相
word		fuzhi_a1;			//幅值
word		bili;				//增加减小比例
byte		yanshi_a1;
byte		pinlv_a1;			//频率
byte		fangxiang_a1;		//1正转2反转
/****************************************************************************************************/
void	FPPA0 (void)
{
.ADJUST_IC	SYSCLK=IHRC/4		//	SYSCLK=IHRC/4
pmode		31;			///8/8/8/8/8/8/8/8带宽共享
fppen	=	0xFF;		//8核全开有8个核心可以分时全部运行,可以分别干8件事8核真爽!
/****************************************************************************************************/
$		led_1		out,low;

/****************************************************************************************************/		//pwm配置
//f----------------0 f----------------0 f----------------0 f----------------0(word,int)
//f----------------0 f----------------0 f----------------0    //12位PWM0,1,2(左对齐)
// ↑上限(pwmcub)    ↑占空比(pwmdt)    |--死区(pwmdz)---|

//上限pwmcub=0xfff0,死区pwmdz=0xff,
//pwm0dtl(先写)pwm0dth,pwm1dtl(先写)pwm1dth,pwm2dtl(先写)pwm2dth,

//最大0xf010,        pwm_h=1+死区,    pwm_l=0,
//最小0x000,0x0010,  pwm_h=0,         pwm_l=1,
//PWM最大0x0fff-死区 =0xf000,
//PWM最小0x0000+2    =0x0020,
//pwm最大值取0xf000-0xff    =<0xef00高脉冲4us
//pwm最小值取0x0020+0xff    =>0x00ff高脉冲4us
/*
a1=0xf010;fuzhi();yanshi();
//a1=0x0000;fuzhi();yanshi();
a1=0x0010;fuzhi();yanshi();
a1=0xf000;fuzhi();yanshi();
a1=0x0020;fuzhi();yanshi();*/

$		pwmgc		enable,updown,reset;
$		pwmgm		protection_enable,ihrc,/4;
//pwmgc		=0b1_0_1_1_0000;		//PWMG控制寄存器位7,停用启用位6,输出状态位5,中心排列模式位4,PWM计数器清零

//pwmgm		=0b0_0_1_0_10_10;		//PWMG分频寄存器位7,上臂反极性位6,下臂反极性位5,臂保护位4,臂保护模式位32,PWM时钟源位10,PWM分频
//pwmgm		=0b0_0_1_0_10_11;		//PWMG分频寄存器

pwmgc1		=0b1_11_0_01_10;		//PWMG控制寄存器1位7,互补发生器位65,三相电机位4,读零位32,PWM5.PWM+位10,PWM4.PWM-

pwmgc2		=0b01_10_01_10;		//PWMG控制寄存器2位76,PWM3.PWM+位54,PWM2.PWM-位32,PWM1.PWM+位10,PWM0.PWM-

pwmcubl		=0b1111_0000;		//pwm上限寄存器l
pwmcubh		=0b1111_1111;		//pwm上限寄存器h

//pwmdz		=0b1111_0000;		//死区寄存器
pwmdz		=0b1111_1111;		//死区寄存器//*注意死区占上臂时间需要扣除

//pwm0dtl		=0b1111_0000;		//pwm0占空比低位寄存器//先写低位
//pwm0dth		=0b1111_1111;		//pwm0占空比高位寄存器

//pwm1dtl		=0b0000_0000;		//pwm1占空比低位寄存器//先写低位
//pwm1dth		=0b1000_0000;		//pwm1占空比高位寄存器

//pwm2dtl		=0b1111_0000;		//pwm2占空比低位寄存器//先写低位
//pwm2dth		=0b0000_0000;		//pwm2占空比高位寄存器

/****************************************************************************************************/
$		k_1		in,pull;		//按键
$		k_2		in,pull;
$		k_3		in,pull;
$		k_4		in,pull;
//pinlv_a1		=49;
//fangxiang_a1	=1;
while (1)
{
anjian();
}
}
/****************************************************************************************************/
void	FPPA1 (void)
{while(1)
{
zhengxianbo();		//正弦波

}
}
/****************************************************************************************************/
void	FPPA2 (void)		//显示
{
while(1)
{
xianshi();
}
}
/****************************************************************************************************/
void	FPPA3 (void)
{
	goto	$;

}
/****************************************************************************************************/
void	FPPA4 (void)
{
	goto	$;
}
/****************************************************************************************************/
void	FPPA5 (void)
{
	goto	$;
}
/****************************************************************************************************/
void	FPPA6 (void)
{
	goto	$;
}
/****************************************************************************************************/
void	FPPA7 (void)
{
	goto	$;
}
/************************************ ****************************************************************/
/*
void	Interrupt (void)
{
	pushaf;

	if (Intrq.T16)
	{	//	T16 Trig
		//	User can add code
		Intrq.T16	=	0;
		//...
	}

	popaf;
}
*/
/****************************************************************************************************/	//pwm
//pwm最大值取	0xf000-0xff    =<0xef00高脉冲4us
//pwm最小值取	0x0020+0xff    =>0x00ff高脉冲4us
//pwm中值		0x7700			=30464
//pwm幅值		fuzhi_a1		<0x7600=30208
//pwm比例		bili			>0x10,<ff
//--------------------------------------------------------------------------0x7700	+fuzhi_a1正峰值
//   /\                /\                /\                /\
//  /  \              /  \              /  \              /  \
// /    \            /    \            /    \            /    \
///      \          /      \          /      \          /      \
//--------------------------------------------------------------------------0x7700	=30464中值0
//         \      /          \      /          \      /          \
//          \    /            \    /            \    /            \
//           \  /              \  /              \  /              \
//            \/ ↑bili         \/                \/                \
//--------------------------------------------------------------------------0x7700	-fuzhi_a1负峰值

void		zhengxianbo()		//正弦波
{
//word		a_1,b_1,c_1;		//abc相
//word		fuzhi_a1;			//幅值
//byte		bili;				//增加减小比例
word		a_a1,b_a1,c_a1;		//计算幅值用
bit			a_b1,b_b1,c_b1;		//状态机1增大0减小
/****************************************************************************************************/	//寄存器初值
fuzhi_a1	=20000;		//幅值			1
//bili		=0xff;//0xf0;		//增大减小比例	2
bili		=0x0100;
pinlv_a1		=49;
yanshi_a1	=pinlv_a1;		//延时控制频率	3
fangxiang_a1	=1;

/*a_1			=0x7700		+fuzhi_a1;			//a相中值+幅值		//相差120°
b_1			=0x7700		-fuzhi_a1>>1;		//b相中值-幅值/2
c_1			=0x7700		-fuzhi_a1>>1;		//c相中值-幅值/2 */
a_1			=0x7700		+fuzhi_a1;							//a相中值+幅值		//相差120°
b_1			=0x7700		-((fuzhi_a1>>1)-(fuzhi_a1>>3));		//b相中值-幅值/2+/8约等于1/3
c_1			=0x7700		-((fuzhi_a1>>1)-(fuzhi_a1>>3));		//c相中值-幅值/2+/8约等于1/3
a_b1		=0;		//a相减小
b_b1		=1;		//b相增大
c_b1		=0;		//c相减小
/****************************************************************************************************/

while(1)
{
/****************************************************************************************************/	//a相
if(a_b1)		//a相增大
	{
	a_a1		=0x7700+fuzhi_a1;	//a相正峰值
	a_a1		-=bili;				//减去增加减小比例
	if(a_1 <a_a1)
		{
		pwm0dtl		=a_1 $0;		//先写
		pwm0dth		=a_1 $1;
		a_1	+=bili;
		}
	else
		{
a_1			=0x7700		+fuzhi_a1;							//a相中值+幅值		//相差120°
b_1			=0x7700		-((fuzhi_a1>>1)-(fuzhi_a1>>3));		//b相中值-幅值/2+/8约等于1/3
c_1			=0x7700		-((fuzhi_a1>>1)-(fuzhi_a1>>3));		//c相中值-幅值/2+/8约等于1/3
//bili		=pinlv_a1<<1;
		a_b1	=0;
		}				//变减小
	}

if(!a_b1)		//a相减小
	{
	a_a1		=0x7700-fuzhi_a1;	//a相负峰值
	a_a1		+=bili;				//加上增加减小比例
	if(a_1 >a_a1)
		{
		pwm0dtl		=a_1 $0;		//先写
		pwm0dth		=a_1 $1;
		a_1	-=bili;
		}
	else{a_b1	=1;}				//变增大
	}
/****************************************************************************************************/	//b相
if(b_b1)		//b相增大
	{
	b_a1		=0x7700+fuzhi_a1;	//b相正峰值
	b_a1		-=bili;				//减去增加减小比例
	if(b_1 <b_a1)
		{
		pwm1dtl		=b_1 $0;
		pwm1dth		=b_1 $1;
		b_1	+=bili;
		}
	else{b_b1	=0;//dingge();
	}				//变减小
	}

if(!b_b1)		//b相减小
	{
	b_a1		=0x7700-fuzhi_a1;	//b相负峰值
	b_a1		+=bili;				//加上增加减小比例
	if(b_1 >b_a1)
		{	
		pwm1dtl		=b_1 $0;
		pwm1dth		=b_1 $1;
		b_1	-=bili;
		}
	else{b_b1	=1;}				//变增大
	}
/****************************************************************************************************/	//c相
if(c_b1)		//c相增大
	{
	c_a1		=0x7700+fuzhi_a1;	//c相正峰值
	c_a1		-=bili;				//减去增加减小比例
	if(c_1 <c_a1)
		{
		pwm2dtl		=c_1 $0;
		pwm2dth		=c_1 $1;
		c_1	+=bili;
		}
	else{c_b1	=0;//dingge();
	}				//变减小
	}

if(!c_b1)		//c相减小
	{
	c_a1		=0x7700-fuzhi_a1;	//c相负峰值
	c_a1		+=bili;				//加上增加减小比例
	if(c_1 >c_a1)
		{
		pwm2dtl		=c_1 $0;
		pwm2dth		=c_1 $1;
		c_1	-=bili;
		}
	else{c_b1	=1;}				//变增大
	}
/****************************************************************************************************/
//fuzhi();
yanshi();
//	yanshi_a1		=100;	yanshi();
//dingge();
}

}
/****************************************************************************************************/
void		fuzhi()			//赋值
{
pwm0dtl		=a_1 $0;		//先写
pwm0dth		=a_1 $1;

pwm1dtl		=b_1 $0;
pwm1dth		=b_1 $1;

pwm2dtl		=c_1 $0;
pwm2dth		=c_1 $1;
}
/****************************************************************************************************/
void		yanshi()			//延时
{
byte		yanshi_b1;
yanshi_b1		=yanshi_a1;
while(yanshi_b1--){nop;nop;nop;nop;}
//.delay	300;
//while(k_1){.delay 1000;if(k_2==0){a1--;fuzhi();}}		//定在这
//while(!k_1){.delay 1000;}
}
/****************************************************************************************************/
void		yanshi1()
{
.delay	30000;
}
/****************************************************************************************************/
void		dingge()			//定格
{
$	k_5	in,pull;
nop;
nop;
while(k_5){nop;}
}
/****************************************************************************************************/
void		xianshi()			//显示
{
byte		xianshi_a1,xianshi_a2;
byte		xianshi_b1,xianshi_b2;		//十位,个位
byte		xianshi_c1,xianshi_c2;		//字模十位,个位
xianshi_b1		=0;
xianshi_b2		=0;
xianshi_c1		=0;
xianshi_c2		=0;
xianshi_a1		=pinlv_a1;
xianshi_a2		=fangxiang_a1;		//1正转2反转
/****************************************************************************************************/

while(xianshi_a1 >9)					//取出频率十位/10(十进制)
{
xianshi_b1		++;
xianshi_a1		-=10;
}
xianshi_b2		=xianshi_a1;				//取出频率个位%10(十进制)
/****************************************************************************************************/	//代替查表
//共阳:0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90//0x88,0x83,0xc6,0xa1,0x86,0x8e
//共阴:0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,0x7f,0x6f//0x77,0x7c,0x39,0x5e,0x79,0x71//用这个
if(xianshi_b1	==0)	{xianshi_c1	=0x3f;}
if(xianshi_b1	==1)	{xianshi_c1	=0x06;}
if(xianshi_b1	==2)	{xianshi_c1	=0x5b;}
if(xianshi_b1	==3)	{xianshi_c1	=0x4f;}
if(xianshi_b1	==4)	{xianshi_c1	=0x66;}
if(xianshi_b1	==5)	{xianshi_c1	=0x6d;}
if(xianshi_b1	==6)	{xianshi_c1	=0x7d;}
if(xianshi_b1	==7)	{xianshi_c1	=0x07;}
if(xianshi_b1	==8)	{xianshi_c1	=0x7f;}
if(xianshi_b1	==9)	{xianshi_c1	=0x6f;}

if(xianshi_b2	==0)	{xianshi_c2	=0x3f;}
if(xianshi_b2	==1)	{xianshi_c2	=0x06;}
if(xianshi_b2	==2)	{xianshi_c2	=0x5b;}
if(xianshi_b2	==3)	{xianshi_c2	=0x4f;}
if(xianshi_b2	==4)	{xianshi_c2	=0x66;}
if(xianshi_b2	==5)	{xianshi_c2	=0x6d;}
if(xianshi_b2	==6)	{xianshi_c2	=0x7d;}
if(xianshi_b2	==7)	{xianshi_c2	=0x07;}
if(xianshi_b2	==8)	{xianshi_c2	=0x7f;}
if(xianshi_b2	==9)	{xianshi_c2	=0x6f;}

/****************************************************************************************************/	//第一种
$		led_1		out,high;
$		led_2		in;
$		led_3		in;
$		led_4		in;
$		led_5		in;

//if(){}									//高
if(xianshi_c2.0){$	led_2	out,low;}		//3a
if(xianshi_c2.2){$	led_3	out,low;}		//3c
if(xianshi_c2.4){$	led_4	out,low;}		//3e
//if(){}									//空
.delay	1000;
/****************************************************************************************************/	//第二种
$		led_1		in;
$		led_2		out,high;
$		led_3		in;
$		led_4		in;
$		led_5		in;

if(xianshi_c2.1){$	led_1	out,low;}		//3b
//if(){}									//高
if(xianshi_c1.0){$	led_3	out,low;}		//2a
if(xianshi_a2==2){$	led_4	out,low;}		//1b反转	//1/正转,2/反转
//if(){}									//空
.delay	1000;
/****************************************************************************************************/	//第三种
$		led_1		in;
$		led_2		in;
$		led_3		out,high;
$		led_4		in;
$		led_5		in;

if(xianshi_c2.3){$	led_1	out,low;}		//3d
if(xianshi_c1.1){$	led_2	out,low;}		//2b
//if(){}									//高
if(xianshi_a2==1){$	led_4	out,low;}		//1a正转	//1/正转,2/反转
//if(){}									//空
.delay	1000;
/****************************************************************************************************/	//第四种
$		led_1		in;
$		led_2		in;
$		led_3		in;
$		led_4		out,high;
$		led_5		in;
if(xianshi_c2.5){$	led_1	out,low;}		//3f
if(xianshi_c1.3){$	led_2	out,low;}		//2d
if(xianshi_c1.2){$	led_3	out,low;}		//2c
//if(){}									//高
//if(){}									//空
.delay	1000
/****************************************************************************************************/	//第五种
$		led_1		in;
$		led_2		in;
$		led_3		in;
$		led_4		in;
$		led_5		out,high;
if(xianshi_c2.6){$	led_1	out,low;}		//3g
if(xianshi_c1.4){$	led_2	out,low;}		//2e
if(xianshi_c1.5){$	led_3	out,low;}		//2f
if(xianshi_c1.6){$	led_4	out,low;}		//2g
//if(){}									//高
.delay	1000;
/****************************************************************************************************/
}
/****************************************************************************************************/
void		anjian()			//按键
{
if(k_1==0)
	{
	pinlv_a1--;
	if(pinlv_a1>254)
		{
		pinlv_a1=0;
		}
	yanshi_a1	=~(pinlv_a1+155);	//小变大(0-99变99-0)
	//yanshi_a1=~(pinlv_a1<<1);		//控制频率
	//yanshi_a1	-=50;
	//yanshi_a1=pinlv_a1;
	}
if(k_2==0)
	{
	pinlv_a1++;
	if(pinlv_a1>99)
		{
		pinlv_a1=99;
		}
	//yanshi_a1=pinlv_a1;
	yanshi_a1	=~(pinlv_a1+155);
	}

.delay 40000;
}
/****************************************************************************************************/

/****************************************************************************************************/
/****************************************************************************************************/
/****************************************************************************************************/
/****************************************************************************************************/